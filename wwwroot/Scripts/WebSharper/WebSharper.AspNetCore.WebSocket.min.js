(function(a){"use strict";var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r;b=a.WebSharper=a.WebSharper||{};c=b.AspNetCore=b.AspNetCore||{};d=c.WebSocket=c.WebSocket||{};e=d.Async=d.Async||{};f=b&&b.Obj;g=d.WebSocketEndpoint=d.WebSocketEndpoint||{};h=d.Client=d.Client||{};i=h.Message=h.Message||{};j=h.WebSocketServer=h.WebSocketServer||{};k=h.WithEncoding=h.WithEncoding||{};l=b&&b.Control;m=l&&l.MailboxProcessor;n=b&&b.Concurrency;o=b&&b.Runtime;p=a.JSON;q=b&&b.Json;r=b&&b.Seq;e.FoldAgent=function(s,t){return m.Start(function(u){function v(w){var x;x=null;return n.Delay(function(){return n.Bind(u.Receive(null),function(y){return n.Bind(t(w,y),function(z){return v(z);});});});}return v(s);},null);};g=d.WebSocketEndpoint=o.Class({get_JsonEncoding:function(){return this.JsonEncoding;},get_URI:function(){return this.uri;}},f,g);g.New=o.Ctor(function(s){f.New.call(this);this.uri=s;this.JsonEncoding={$:0};},g);i.Close={$:3};i.Open={$:2};i.Error={$:1};j=h.WebSocketServer=o.Class({Post:function(s){this.conn.send(this.encode(s));},get_Connection:function(){return this.conn;}},f,j);j.New=o.Ctor(function(s,t){f.New.call(this);this.conn=s;this.encode=t;},j);k.Connect=function(s,t,u,v){return k.FromWebSocket(s,t,new a.WebSocket(u.get_URI()),v,u.get_JsonEncoding());};k.ConnectStateful=function(s,t,u,v){return k.FromWebSocketStateful(s,t,new a.WebSocket(u.get_URI()),v,u.get_JsonEncoding());};k.FromWebSocket=function(s,t,u,v,w){var x,y,z,A,B;x=h.getEncoding(s,t,w);y=x[1];z=h.cacheSocket(u,y);A=new j.New(u,x[0]);B=null;return n.Delay(function(){return n.Bind(v(A),function(C){function D(E,F){var G;G=z(C);u.onopen=function(){C(i.Open);return E(A);};u.onclose=function(){return C(i.Close);};u.onmessage=function(H){return C({$:0,$0:y(H)});};u.onerror=function(){C(i.Error);return F(new a.Error("Could not connect to the server."));};if(G)E(A);}return n.FromContinuations(function(E,F,G){return D.apply(null,[E,F,G]);});});});};k.FromWebSocketStateful=function(s,t,u,v,w){var x,y,z,A,B;x=h.getEncoding(s,t,w);y=x[1];z=h.cacheSocket(u,y);A=new j.New(u,x[0]);B=null;return n.Delay(function(){return n.Bind(v(A),function(C){var D,E;function F(G,H){var I;I=z(function(J){E.mailbox.AddLast(J);E.resume();});u.onopen=function(){E.mailbox.AddLast(i.Open);E.resume();return G(A);};u.onclose=function(){E.mailbox.AddLast(i.Close);return E.resume();};u.onmessage=function(J){E.mailbox.AddLast({$:0,$0:y(J)});return E.resume();};u.onerror=function(){E.mailbox.AddLast(i.Error);E.resume();return H(new a.Error("Could not connect to the server."));};if(I)G(A);}D=C[1];E=e.FoldAgent(C[0],function(G,H){return(D(G))(H);});return n.FromContinuations(function(G,H,I){return F.apply(null,[G,H,I]);});});});};h.getEncoding=function(s,t,u){var v,w;function x(y){return p.parse(y);}v=u.$==0?[function(y){return p.stringify(y);},function(y){return q.Activate(x(y));}]:[s,t];w=v[1];return[v[0],function(y){return w(y.data);}];};h.cacheSocket=function(s,t){var u,v;u=[];v=[false];s.onopen=function(){u.push(i.Open);v[0]=true;};s.onclose=function(){return u.push(i.Close);};s.onmessage=function(w){return u.push({$:0,$0:t(w)});};s.onerror=function(){return u.push(i.Error);};return function(w){r.iter(w,u);return v[0];};};}(self));
